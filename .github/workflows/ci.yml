name: CI

on:
  push:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            usbguard \
            policykit-1 \
            pkg-config \
            build-essential \
            libudev1 \
            libudev-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            libdbus-1-dev \
            libusbguard-dev \
            libssl-dev \
            libsystemd-dev \
            libpam0g-dev

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: rustfmt, clippy
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check code formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests (unit)
        run: cargo test --no-fail-fast --workspace

      - name: Setup D-Bus for integration tests
        run: |
          # Create D-Bus system configuration directory
          sudo mkdir -p /etc/dbus-1/system.d/
          
          # Create a policy file to allow our daemon to own its service
          cat << 'EOF' | sudo tee /etc/dbus-1/system.d/lusby.conf > /dev/null
          <!DOCTYPE busconfig PUBLIC "-//freedesktop//DTD D-Bus Bus Configuration 1.0//EN"
           "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
          <busconfig>
            <policy user="root">
              <allow own="org.lusby.Daemon"/>
              <allow send_destination="org.lusby.Daemon"/>
              <allow receive_sender="org.lusby.Daemon"/>
            </policy>
            <policy context="default">
              <allow send_destination="org.lusby.Daemon"/>
              <allow receive_sender="org.lusby.Daemon"/>
            </policy>
          </busconfig>
          EOF
          
          # Start system D-Bus daemon for tests
          sudo mkdir -p /run/dbus
          sudo dbus-daemon --system --fork
          
          # Start usbguard in test mode
          sudo mkdir -p /etc/usbguard
          echo "Rule=block" | sudo tee /etc/usbguard/usbguard-daemon.conf > /dev/null
          # Create rules file with proper permissions
          sudo touch /etc/usbguard/rules.conf
          sudo chmod 644 /etc/usbguard/rules.conf
          # Generate policy and write to file
          sudo usbguard generate-policy | sudo tee /etc/usbguard/rules.conf > /dev/null
          # Ensure usbguard can read the rules file
          sudo chown -R root:root /etc/usbguard
          sudo chmod -R 644 /etc/usbguard/*
          # Start usbguard
          sudo systemctl start usbguard

      - name: Run integration tests
        env:
          GU_TEST_SYSTEM: 1
          RUST_LOG: debug
          DBUS_VERBOSE: 1
        run: |
          set -ex
          
          # Verify D-Bus is running
          if ! pgrep dbus-daemon > /dev/null; then
            echo "Error: D-Bus daemon is not running"
            exit 1
          fi
          
          # Verify D-Bus configuration
          echo "D-Bus configuration:"
          ls -la /etc/dbus-1/system.d/
          
          # Build the daemon
          cargo build -p lusby-daemon
          
          # Start the daemon with verbose output
          echo "Starting daemon..."
          sudo RUST_LOG=debug target/debug/lusby-daemon &
          DAEMON_PID=$!
          
          # Give the daemon a moment to start
          sleep 5
          
          # Check if daemon is running
          if ! ps -p $DAEMON_PID > /dev/null; then
            echo "Error: Daemon process failed to start"
            exit 1
          fi
          
          # Check if daemon registered with D-Bus
          if ! dbus-send --system --dest=org.freedesktop.DBus \
               --type=method_call --print-reply /org/freedesktop/DBus \
               org.freedesktop.DBus.ListNames 2>/dev/null | grep -q org.lusby.Daemon; then
            echo "Error: Daemon failed to register with D-Bus"
            echo "D-Bus services:"
            dbus-send --system --dest=org.freedesktop.DBus \
              --type=method_call --print-reply /org/freedesktop/DBus \
              org.freedesktop.DBus.ListNames || true
            exit 1
          fi
          
          echo "Daemon started successfully with PID $DAEMON_PID"
          
          # Run tests
          cargo test --no-fail-fast --workspace --exclude lusby-tray
          
          # Cleanup
          echo "Stopping daemon..."
          if ps -p $DAEMON_PID > /dev/null; then
            sudo kill $DAEMON_PID || true
            # Give it a moment to shut down
            sleep 2
            # Force kill if still running
            if ps -p $DAEMON_PID > /dev/null; then
              echo "Force killing daemon..."
              sudo kill -9 $DAEMON_PID || true
            fi
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            usbguard \
            policykit-1 \
            pkg-config \
            build-essential \
            libudev1 \
            libudev-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            libdbus-1-dev \
            libusbguard-dev \
            pkg-config \
            libssl-dev \
            libsystemd-dev \
            libpam0g-dev

      - name: Build all targets
        run: |
          cargo build --release --workspace --all-features
          
      - name: Build Debian package
        run: |
          cargo install cargo-deb
          cd crates/daemon
          echo "Current directory: $(pwd)"
          echo "Building Debian package..."
          CARGO_TARGET_DIR=../../target cargo deb --no-build --no-strip
          echo "Listing target directory: $(pwd)/../../target/debian/"
          ls -la ../../target/debian/
