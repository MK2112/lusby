name: CI

on:
  push:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            libdbus-1-dev \
            libudev-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            usbguard \
            policykit-1

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: rustfmt, clippy
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check code formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests (unit)
        run: cargo test --no-fail-fast --workspace --exclude guardianusb-tray

      - name: Setup D-Bus for integration tests
        run: |
          # Start system D-Bus daemon for tests
          sudo mkdir -p /run/dbus
          sudo dbus-daemon --system --fork
          
          # Start usbguard in test mode
          sudo mkdir -p /etc/usbguard
          echo "Rule=block" | sudo tee /etc/usbguard/usbguard-daemon.conf > /dev/null
          # Create rules file with proper permissions
          sudo touch /etc/usbguard/rules.conf
          sudo chmod 644 /etc/usbguard/rules.conf
          # Generate policy and write to file
          sudo usbguard generate-policy | sudo tee /etc/usbguard/rules.conf > /dev/null
          # Ensure usbguard can read the rules file
          sudo chown -R root:root /etc/usbguard
          sudo chmod -R 644 /etc/usbguard/*
          # Start usbguard
          sudo systemctl start usbguard

      - name: Run integration tests
        env:
          GU_TEST_SYSTEM: 1
        run: |
          set -e
          # Start the daemon in the background
          cargo build -p guardianusb-daemon
          sudo target/debug/guardianusb-daemon &
          DAEMON_PID=$!
          
          # Give the daemon a moment to start
          sleep 2
          
          # Check if daemon is running
          if ! ps -p $DAEMON_PID > /dev/null; then
            echo "Error: Daemon failed to start"
            exit 1
          fi
          
          # Run tests
          cargo test --no-fail-fast --workspace --exclude guardianusb-tray
          
          # Cleanup
          if ps -p $DAEMON_PID > /dev/null; then
            echo "Stopping daemon..."
            sudo kill $DAEMON_PID || true
            # Give it a moment to shut down
            sleep 1
            # Force kill if still running
            if ps -p $DAEMON_PID > /dev/null; then
              sudo kill -9 $DAEMON_PID || true
            fi
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build all targets
        run: |
          cargo build --release --workspace --all-features
          
      - name: Build Debian package
        run: |
          cargo install cargo-deb
          cd crates/daemon
          cargo deb --no-build --no-strip
          ls -la target/debian/
